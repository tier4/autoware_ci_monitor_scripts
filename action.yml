name: "Code quality visualizer"
author: "Keisuke Shima"
description: "Measure code metrics and generate result page"
branding:
  icon: "activity"
  color: "blue"

inputs:
  artifacts-dir:
    description: "Path to Artifacts generated using this Action (must include lcov-result/ and lizard-result/ directory)"
    required: true
  base-url:
    description: "If you use example/hugo-site in this repository, please specify the baseURL."
    required: true
  title:
    description: "If you use example/hugo-site in this repository, please specify the title."
    required: true
  ros-distro:
    description: "ROS distribution"
    required: true
    default: "foxy"
  hugo-dir:
    description: "If you want to use your own hugo-site, specify the root directory"
    required: true
    default: "${GITHUB_ACTION_PATH}/example/hugo-site"
  output-dir:
    description: "Hugo output directory"
    required: true
    default: "${GITHUB_WORKSPACE}/public"
  lcovrc-path:
    description: "Path to .lcovrc file"
    required: true
    default: "${GITHUB_ACTION_PATH}/.lcovrc"
  CCN:
    description: "Threshold for cyclomatic complexity number warning. The default value is 15."
    required: true
    default: "15"
  nloc:
    description: "Threshold for NLOC. The default value is 1000000."
    required: true
    default: "1000000"
  arguments:
    description: "Limit for number of parameters. The default value is 100."
    required: true
    default: "100"
  exclude:
    description: "Space separated list of exclude paths."
    required: false
  codechecker-config-path:
    description: "Path to codechecker-config.json file"
    required: true
    default: "${GITHUB_ACTION_PATH}/codechecker-config.json"

outputs:
  output-dir:
    description: "Hugo output directory"
    value: ${{ inputs.output-dir }}

runs:
  using: "composite"
  steps:
    - name: Filtering input
      id: filtered
      run: |
        echo ${{ inputs.artifacts-dir }} | sed -e "s@/\$@@"
        echo ${{ inputs.hugo-dir }} | sed -e "s@/\$@@"
        echo ${{ inputs.output-dir }} | sed -e "s@/\$@@"
        echo ::set-output name=ARTIFACTS_DIR::${{ inputs.artifacts-dir }} | sed -e "s@/\$@@"
        echo ::set-output name=HUGO_DIR::${{ inputs.hugo-dir }} | sed -e "s@/\$@@"
        echo ::set-output name=OUTPUT_DIR::${{ inputs.output-dir }} | sed -e "s@/\$@@"
      shell: bash

    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y lcov git python-is-python3 python3-pip hugo
        pip3 install jinja2 bs4 pandas plotly
      shell: bash

    - name: Set timestamp
      run: |
        date -u '+%Y%m%d_%H%M%S' > ${GITHUB_WORKSPACE}/timestamp.txt
      shell: bash

    - name: Run clang-tidy
      run: |
        . /opt/ros/${{ inputs.ros-distro }}/setup.sh
        colcon build --event-handlers console_cohesion+ \
                      --cmake-args \
                        -DCMAKE_BUILD_TYPE=Release \
                        -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        apt-get install -y clang-11 clang-tidy-11 libomp-dev libomp-10-dev
        update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-11 9999
        update-alternatives --install /usr/bin/clang clang /usr/bin/clang-11 9999
        update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-11 9999
        git clone https://github.com/Ericsson/codechecker.git
        apt-get install -y gcc-multilib python3-venv
        cd codechecker
        make venv || true
        . "${PWD}/venv/bin/activate"
        BUILD_UI_DIST=NO make package || true
        cd ..
        export PATH="${PWD}/codechecker/build/CodeChecker/bin:$PATH"
        TIMESTAMP=$(cat ${GITHUB_WORKSPACE}/timestamp.txt)
        CodeChecker analyze ${GITHUB_WORKSPACE}/build/compile_commands.json --config ${{ inputs.codechecker-config-path }} --ignore "${GITHUB_ACTION_PATH}"/codechecker-skip-list.txt --output ./reports
        CodeChecker parse -e html ./reports -o ${{ steps.filtered.outputs.ARTIFACTS_DIR }}/tidy-reports/$TIMESTAMP --trim-path-prefix ${GITHUB_WORKSPACE} || true
        deactivate
      shell: bash

    - name: Measure code quality index
      run: |
        echo "Artifacts directory is ${{ steps.filtered.outputs.ARTIFACTS_DIR }}"
        mkdir -p ${{ steps.filtered.outputs.ARTIFACTS_DIR }}
        TIMESTAMP=$(cat ${GITHUB_WORKSPACE}/timestamp.txt)
        . /opt/ros/${{ inputs.ros-distro }}/setup.sh
        python ${GITHUB_ACTION_PATH}/scripts/ros_metrics_reporter.py \
          --base-dir=${GITHUB_WORKSPACE} \
          --action-dir=${GITHUB_ACTION_PATH} \
          --output-dir=${{ steps.filtered.outputs.ARTIFACTS_DIR }} \
          --timestamp=${TIMESTAMP} \
          --lcovrc=${{ inputs.lcovrc-path }} \
          --hugo-root-dir=${{ steps.filtered.outputs.HUGO_DIR }} \
          --base-url=${{ inputs.base-url }} \
          --title=${{ inputs.title }} \
          --exclude=${{ inputs.exclude }}
      shell: bash

    - name: Generate pages
      run: |
        cd ${{ steps.filtered.outputs.HUGO_DIR }} && hugo -d ${{ steps.filtered.outputs.OUTPUT_DIR }}
      shell: bash
