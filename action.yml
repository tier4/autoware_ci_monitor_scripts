name: "Code quality visualizer"
author: "Keisuke Shima"
description: "Measure code metrics and generate result page"
branding:
  icon: "activity"
  color: "blue"

inputs:
  artifacts-dir:
    description: "Path to Artifacts generated using this Action (must include lcov-result/ and lizard-result/ directory)"
    required: true
  base-url:
    description: "If you use example/hugo-site in this repository, please specify the baseURL."
    required: true
  title:
    description: "If you use example/hugo-site in this repository, please specify the title."
    required: true
  ros-distro:
    description: "ROS distribution"
    required: true
    default: "foxy"
  hugo-dir:
    description: "If you want to use your own hugo-site, specify the root directory"
    required: true
    default: "${GITHUB_ACTION_PATH}/example/hugo-site"
  output-dir:
    description: "Hugo output directory"
    required: true
    default: "${GITHUB_WORKSPACE}/public"
  lcovrc-path:
    description: "Path to .lcovrc file"
    required: true
    default: "${GITHUB_ACTION_PATH}/.lcovrc"
  CCN:
    description: "Threshold for cyclomatic complexity number warning. The default value is 15."
    required: true
    default: "15"
  nloc:
    description: "Threshold for NLOC. The default value is 1000000."
    required: true
    default: "1000000"
  arguments:
    description: "Limit for number of parameters. The default value is 100."
    required: true
    default: "100"
  exclude:
    description: "Space separated list of exclude paths."
    required: false
  codechecker-config-path:
    description: "Path to codechecker-config.json file"
    required: false
  codechecker-skip-list:
    description: "Path to codechecker-skip-list"
    required: false

outputs:
  output-dir:
    description: "Hugo output directory"
    value: ${{ inputs.output-dir }}

runs:
  using: "composite"
  steps:
    - name: Filtering input
      id: filtered
      env:
        _CODECHECKER_CONFIG_PATH: ${{ inputs.codechecker-config-path }}
        _CODECHECKER_SKIP_LIST: ${{ inputs.codechecker-skip-list }}
      run: |
        echo ::set-output name=ARTIFACTS_DIR::$(echo ${{ inputs.artifacts-dir }} | sed -e "s@/\$@@")
        echo ::set-output name=HUGO_DIR::$(echo ${{ inputs.hugo-dir }} | sed -e "s@/\$@@")
        echo ::set-output name=OUTPUT_DIR::$(echo ${{ inputs.output-dir }} | sed -e "s@/\$@@")
        _CODECHECKER_CONFIG_PATH=${_CODECHECKER_CONFIG_PATH:+$GITHUB_WORKSPACE"/"$_CODECHECKER_CONFIG_PATH}
        _CODECHECKER_CONFIG_PATH=${_CODECHECKER_CONFIG_PATH:-$GITHUB_ACTION_PATH"/codechecker-config.json"}
        echo "Debug: CODECHECKER_CONFIG_PATH=$_CODECHECKER_CONFIG_PATH"
        echo ::set-output name=CODECHECKER_CONFIG_PATH::$_CODECHECKER_CONFIG_PATH
        _CODECHECKER_SKIP_LIST=${_CODECHECKER_SKIP_LIST:+$GITHUB_WORKSPACE"/"$_CODECHECKER_SKIP_LIST}
        _CODECHECKER_SKIP_LIST=${_CODECHECKER_SKIP_LIST:-$GITHUB_ACTION_PATH"/codechecker-skip-list.txt"}
        echo "Debug: CODECHECKER_SKIP_LIST=$_CODECHECKER_SKIP_LIST"
        echo ::set-output name=CODECHECKER_SKIP_LIST::$_CODECHECKER_SKIP_LIST
      shell: bash

    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y lcov git python-is-python3 python3-pip hugo
        apt-get install -y clang-tidy-11
        update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-11 9999
        apt-get install -y gcc-multilib python3-venv
        pip3 install jinja2 bs4 pandas plotly
      shell: bash

    - name: Set timestamp
      run: |
        date -u '+%Y%m%d_%H%M%S' > ${GITHUB_WORKSPACE}/timestamp.txt
      shell: bash

    - name: Run CodeChecker
      run: |
        . /opt/ros/${{ inputs.ros-distro }}/setup.sh
        TIMESTAMP=$(cat ${GITHUB_WORKSPACE}/timestamp.txt)
        colcon build \
          --event-handlers console_cohesion+ \
          --cmake-args -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        git clone https://github.com/Ericsson/codechecker.git --depth 1 ${GITHUB_ACTION_PATH}/codechecker
        cd ${GITHUB_ACTION_PATH}/codechecker
        make venv || true
        . "${PWD}/venv/bin/activate"
        BUILD_UI_DIST=NO make package || true
        cd ..
        echo "Debug: CODECHECKER_CONFIG_PATH=${{ steps.filtered.CODECHECKER_CONFIG_PATH }}"
        echo "Debug: CODECHECKER_SKIP_LIST=${{ steps.filtered.CODECHECKER_SKIP_LIST }}"
        codechecker/build/CodeChecker/bin/CodeChecker analyze ${GITHUB_WORKSPACE}/build/compile_commands.json \
          --config ${{ steps.filtered.CODECHECKER_CONFIG_PATH }} \
          --ignore ${{ steps.filtered.CODECHECKER_SKIP_LIST }} \
          --output ./reports || true
        codechecker/build/CodeChecker/bin/CodeChecker parse -e html ./reports \
          -o ${GITHUB_WORKSPACE}/${ARTIFACTS_DIR}/tidy-reports/$TIMESTAMP \
          --trim-path-prefix ${GITHUB_WORKSPACE} || true
      shell: bash

    - name: Measure code quality index
      run: |
        echo "Artifacts directory is ${{ steps.filtered.outputs.ARTIFACTS_DIR }}"
        mkdir -p ${{ steps.filtered.outputs.ARTIFACTS_DIR }}
        TIMESTAMP=$(cat ${GITHUB_WORKSPACE}/timestamp.txt)
        . /opt/ros/${{ inputs.ros-distro }}/setup.sh
        python ${GITHUB_ACTION_PATH}/scripts/ros_metrics_reporter.py \
          --base-dir=${GITHUB_WORKSPACE} \
          --action-dir=${GITHUB_ACTION_PATH} \
          --output-dir=${{ steps.filtered.outputs.ARTIFACTS_DIR }} \
          --timestamp=${TIMESTAMP} \
          --lcovrc=${{ inputs.lcovrc-path }} \
          --hugo-root-dir=${{ steps.filtered.outputs.HUGO_DIR }} \
          --base-url=${{ inputs.base-url }} \
          --title=${{ inputs.title }} \
          --exclude="${{ inputs.exclude }}" \
          --ccn=${{ inputs.CCN }} \
          --nloc=${{ inputs.nloc }} \
          --arguments=${{ inputs.arguments }}
      shell: bash

    - name: Generate pages
      run: |
        cd ${{ steps.filtered.outputs.HUGO_DIR }} && hugo -d ${{ steps.filtered.outputs.OUTPUT_DIR }}
      shell: bash
