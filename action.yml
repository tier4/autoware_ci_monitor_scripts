name: "Code quality visualizer"
author: "Keisuke Shima"
description: "Measure code metrics and generate result page"
branding:
  icon: "activity"
  color: "blue"

inputs:
  artifacts-dir:
    description: "Path to Artifacts generated using this Action (must include lcov/ and lizard-result/ directory)"
    required: true
  ros-distro:
    description: "ROS2 distribution"
    required: true
    default: "foxy"
  hugo-dir:
    description: "If you want to use your own hugo-site, specify the root directory"
    required: true
    default: "${GITHUB_ACTION_PATH}/example/hugo-site"
  output-dir:
    description: "Hugo output directory"
    required: true
    default: "${GITHUB_WORKSPACE}/public"
  lcovrc-path:
    description: "Path to .lcovrc file"
    required: true
    default: "${GITHUB_ACTION_PATH}/.lcovrc"
  CCN:
    description: "Threshold for cyclomatic complexity number warning. The default value is 15."
    required: true
    default: 15
  nloc:
    description: "Threshold for NLOC. The default value is 1000000."
    required: true
    default: 1000000
  arguments:
    description: "Limit for number of parameters. The default value is 100."
    required: true
    default: 100

outputs:
  output-dir:
    description: "Hugo output directory"
    value: ${{ inputs.output-dir }}

runs:
  using: "composite"
  steps:
    - name: Preprocess
      run: |
        echo "GITHUB_ACTION_PATH is ${GITHUB_ACTION_PATH}"
        ls -l ${GITHUB_ACTION_PATH}
        echo "github.action_path is ${{ github.action_path }}"
        echo "GITHUB_WORKSPACE is ${GITHUB_WORKSPACE}"
        ls -l ${GITHUB_WORKSPACE}
        echo "Workspace is ${{ github.workspace }}"
        ARTIFACTS_DIR=${${{ inputs.artifacts-dir }}%/}
        echo "Artifacts directory is $ARTIFACTS_DIR"
        HUGO_DIR=${${{ inputs.hugo-dir }}%/}
        echo "Hugo directory is $HUGO_DIR"
        OUTPUT_DIR=${${{ inputs.output-dir }}%/}
        echo "Output directory is $OUTPUT_DIR"
      shell: bash

    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y lcov git python-is-python3 python3-pip hugo
        rosdep update
        rosdep install -y --from-paths . --ignore-src --rosdistro ${{ inputs.ros-distro }}
        pip3 install jinja2 bs4 pandas plotly
      shell: bash

    - name: Set timestamp
      run: |
        echo "Creating timestamp to ${GITHUB_WORKSPACE}/timestamp.txt"
        date -u '+%Y%m%d_%H%M%S' > ${GITHUB_WORKSPACE}/timestamp.txt
      shell: bash

    - name: Measure code coverage
      run: |
        echo "Artifacts directory is ${ARTIFACTS_DIR}"
        mkdir -p ${ARTIFACTS_DIR}
        echo "Run coverage.sh"
        . /opt/ros/${{ inputs.ros-distro }}/setup.sh
        ${GITHUB_ACTION_PATH}/scripts/coverage.sh ${GITHUB_WORKSPACE} ${ARTIFACTS_DIR} ${GITHUB_WORKSPACE}/timestamp.txt
      shell: bash

    - name: Measure code metrics
      run: |
        echo "Run lizard.sh"
        ${GITHUB_ACTION_PATH}/scripts/lizard.sh ${GITHUB_WORKSPACE} ${ARTIFACTS_DIR} ${{ inputs.CCN }} ${{ inputs.nloc }} ${{ inputs.arguments }} ${GITHUB_WORKSPACE}/timestamp.txt
      shell: bash

    - name: Scraping
      run: |
        echo "Run scraping.py"
        TIMESTAMP=$(cat ${GITHUB_WORKSPACE}/timestamp.txt)
        mkdir -p ${ARTIFACTS_DIR}/metrics/$TIMESTAMP
        python3 scripts/scraping.py --lcov_dir=${ARTIFACTS_DIR}/lcov/$TIMESTAMP/ --lizard_dir=${ARTIFACTS_DIR}/lizard_result/$TIMESTAMP/ --output_dir=${ARTIFACTS_DIR}/metrics/$TIMESTAMP/
      shell: bash

    - name: Create static page
      run: |
        ln -nfrs ${ARTIFACTS_DIR}/lcov/$TIMESTAMP ${ARTIFACTS_DIR}/lcov/latest
        ln -nfrs ${ARTIFACTS_DIR}/lizard_result/$TIMESTAMP ${ARTIFACTS_DIR}/lizard_result/latest
        ln -nfrs ${ARTIFACTS_DIR}/metrics/$TIMESTAMP ${ARTIFACTS_DIR}/metrics/latest
        echo "Run main.py"
        python scripts/main.py --input-dir=${ARTIFACTS_DIR}/metrics/ --hugo-root-dir=${HUGO_DIR} --hugo-template-dir=${GITHUB_ACTION_PATH}/template/hugo/ --lcov-result-path=${ARTIFACTS_DIR}/lcov/latest/ --lizard-result-path=${ARTIFACTS_DIR}/lizard_result/latest/
      shell: bash

    - name: Generate pages
      run: |
        echo "Copy artifacts"
        cp -r ${HUGO_DIR} /tmp/
        cp -r ${ARTIFACTS_DIR}/* /tmp//hugo-site
        ls -l /tmp/hugo-site
        cd /tmp/hugo-site && hugo -d ${OUTPUT_DIR}
      shell: bash
